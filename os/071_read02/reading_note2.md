# 地址及其转换

在 IA-32 架构中，有三种类型的地址：逻辑地址、线性地址和物理地址。以下是每种地址的简要描述以及它们之间如何进行转换：

1. 逻辑地址：逻辑地址是 CPU 在地址转换的第一阶段生成的 32 位地址。它由段选择器和段内偏移量组成。段选择器用于识别 GDT 或 LDT 中的一个段，偏移量是段内的相对地址。

2. 线性地址：线性地址是通过将段基地址与逻辑地址的偏移量相加生成的 32 位地址。这是由内存管理单元（MMU）在地址转换的第二阶段完成的。MMU 使用页目录和页表将线性地址映射到物理地址。

3. 物理地址：物理地址是存储数据的实际内存地址。它由 MMU 在地址转换的最后一阶段生成。

这些地址之间的转换涉及两个阶段的地址转换：

1. 逻辑地址转换为线性地址：这涉及将段选择器乘以 8 以获取 GDT 或 LDT 中的段描述符地址。段描述符包含段的基地址，将其与逻辑地址的偏移量相加即可得到线性地址。

2. 线性地址转换为物理地址：这涉及使用页目录和页表将线性地址映射到物理地址。页目录包含页表的基地址，页表包含物理内存页的基地址。页目录和页表条目包含标志，指示页面是否存在于物理内存中、是否可写以及是否对用户代码可访问。在转换过程中，MMU 还会执行各种检查，以确保页面和页表条目有效，并且进程具有访问内存所需的权限。

# 分段模型

IA-32 架构使用分段模型来管理内存。这个模型将物理内存划分为段，每个段都可以以不同的方式进行保护和访问。在 IA-32 架构中使用了三种分段模型：基本平坦模型、保护平坦模型和多段模型。

1. 基本平坦模型：在基本平坦模型中，只有一个跨越整个物理内存的段。这个模型用于实模式，即处理器开机时启动的模式。在这个模式中，段基地址始终为 0，段限制为可寻址内存大小的最大值 1MB。这个模型使用简单，但是存在限制，例如缺乏内存保护。基本平坦模型使用一个跨越整个物理内存的单一段。这个模型用于实模式，这是一个提供直接访问硬件资源的 16 位模式。在实模式中，CPU 通过将 16 位段选择器和 16 位偏移量组合在一起生成 20 位地址。段选择器是指向段描述符表（SDT）的索引，其中包含描述每个段的基地址、限制和访问权限的段描述符。

2. 保护平坦模型：在保护平坦模型中，同样只有一个跨越整个物理内存的段。但是，这个模型用于保护模式，提供了内存保护和虚拟内存。在这个模型中，段基地址仍然为 0，但是段限制可以设置为更大的值，例如 4GB。这允许处理器访问比实模式更多的内存。但是，内存访问仍然限制在单个段中。在保护模式中，CPU 通过将 16 位段选择器和 32 位偏移量组合在一起生成 32 位线性地址。段选择器是指向全局描述符表（GDT）或本地描述符表（LDT）的索引，其中包含描述每个段的基地址、限制和访问权限的段描述符。使用 LGDT 或 LLDT 指令将 GDT 或 LDT 加载到内存中。

3. 多段模型：在多段模型中，物理内存被分为多个段，每个段都有自己的基地址和限制。这个模型用于保护模式，允许更灵活的内存管理。它提供内存保护、虚拟内存，并支持使用多个任务或进程。每个任务或进程可以拥有自己的一组段，由操作系统管理。每个任务或进程可以拥有自己的一组段，由操作系统管理。多段模型使用 GDT 和 LDT 的组合来描述段描述符。GDT 包含所有任务或进程共享的段描述符，而每个任务或进程都有自己的 LDT，其中包含特定于该任务或进程的段描述符。使用 LLDTR 指令将 LDT 加载到内存中。

分段模型用于管理 IA-32 架构中的内存。基本平坦模型用于实模式，而保护平坦模型和多段模型用于保护模式。保护平坦模型和多段模型提供内存保护、虚拟内存和更灵活的内存管理。

# 逻辑地址和线性地址的转换

逻辑地址和线性地址之间的转换涉及使用段选择器、段寄存器和段描述符。

1. 段选择器：段选择器是一个 16 位的值，用于索引到段描述符表（GDT 或 LDT）以获取段描述符。段选择器由两部分组成：一个 13 位的索引和三个请求特权级（RPL）的位。

2. 段寄存器：IA-32 架构中有六个段寄存器：CS（代码段）、DS（数据段）、SS（栈段）、ES（附加段）、FS（F 段）和 GS（G 段）。这些段寄存器中的每一个都保存一个段选择器，指向 GDT 或 LDT 中的一个段描述符。

为了使用段选择器加载段寄存器，需要使用 LDS、LES、LSS、LFS、LGS 或 LDT 指令。这些指令将段选择器加载到段寄存器中，并导致处理器将相应的段描述符加载到描述符缓存中。

3. 段描述符

![1681527004846](image/reading_note2/1681527004846.png)


- 段限制（位 0-15）：指定段的大小（以字节为单位）。
- 段基地址（位 0-15）：指定段的线性基地址的低 16 位。
- 段基地址（位 16-23）：指定段的线性基地址的中间 8 位。
- 段类型和属性：指定段的类型和访问权限。此字段分为四个子字段：
- 类型（位 40-43）：指定段的类型，如代码段或数据段。
- S（位 44）：指定段是系统段还是代码/数据段。
- DPL（位 45-46）：指定访问段所需的特权级别。
- P（位 47）：指定段是否存在于内存中。
- 段限制（位 16-19）和标志：指定段限制的高 4 位和各种标志。此字段分为两个子字段：
- AVL（位 52）：供软件使用的可用位。
- L（位 53）：指定段是否是 64 位代码段。
- D/B（位 54）：指定段是 32 位代码段还是数据段。
- G（位 55）：指定段限制的粒度。
- res：保留以供将来使用。
- 段基地址（位 32-63）：指定段的线性基地址的高 32 位。


当在保护模式下访问一个段时，处理器使用段描述符来确定正在访问的内存位置的线性地址。段描述符指定段的基地址和限制，以及其访问权限。处理器使用段基地址将偏移量加到基地址上来计算线性地址。处理器还检查限制，以确保正在访问的内存位置满足段限制。


# 段描述符的分类

数据段描述符：该类型描述符用于描述包含数据的段，例如全局变量或局部变量。描述符包含有关段的基地址、限制、访问权限和类型的信息。数据段可以用于读取和写入操作。

- 代码段描述符：该类型描述符用于描述包含可执行代码的段。描述符包含有关段的基地址、限制、访问权限和类型的信息。代码段可以用于执行代码，但不能用于数据存储或修改。

- 局部描述符表（LDT）段描述符：该类型描述符用于描述包含 LDT 的段，LDT 是一个包含附加段描述符的表。描述符包含有关 LDT 的基地址、限制和访问权限的信息。

- 任务状态段（TSS）描述符：该类型描述符用于描述包含 TSS 的段，TSS 是一个数据结构，保存有关任务的信息，例如其状态和上下文。描述符包含有关 TSS 的基地址、限制和访问权限的信息。

- 调用门描述符：该类型描述符用于特权级之间的控制转移。调用门是一种保护模式门，用于从较低特权级转移到较高特权级。描述符包含有关调用门的选择子、偏移量、访问权限和参数计数的信息。

- 中断门描述符：该类型描述符用于处理中断。中断门用于将控制转移至不同特权级中的中断处理程序例程。描述符包含有关中断门的选择子、偏移量、访问权限和类型的信息。

- 陷阱门描述符：该类型描述符用于处理陷阱。陷阱门用于将控制转移至同一特权级中的陷阱处理程序例程。描述符包含有关陷阱门的选择子、偏移量、访问权限和类型的信息。

- 任务门描述符：该类型描述符用于任务切换。任务门用于将控制转移至描述要执行的任务的 TSS。描述符包含有关任务门的选择子、访问权限和 TSS 段选择子的信息。

在 IA-32 架构中，段描述符用于描述各种类型的段和控制转移。描述符包含有关段的基地址、限制、访问权限和类型的信息。数据段、代码段、LDT 段、TSS 段、调用门、中断门、陷阱门和任务门都使用不同类型的描述符。通过使用这些描述符，处理器可以将逻辑地址转换为线性地址，并管理特权级别和任务切换。

