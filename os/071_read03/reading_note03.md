## 3.1. 中断和异常处理概述
中断（Interrupt）和异常（Exception）是计算机系统中用于处理硬件或软件异常情况的两种机制。

中断是一种由计算机硬件或外部设备发出的信号，用于请求处理器暂停当前正在执行的程序，转而执行一个特定的中断处理程序（ISR），以响应外部事件或处理器内部错误。中断可以由多种事件触发，例如外部设备的输入、定时器的溢出、硬件错误等。

异常是一种在程序执行过程中出现的错误或意外情况，例如非法的指令、访问越界的内存、除零错误等。异常通常由处理器内部检测到，并触发一个特定的异常处理程序（Exception Handler）来处理异常情况。

处理器在遇到中断或异常时，会采取以下步骤来进行处理：

1. 保存执行现场：处理器会保存当前正在执行的程序的状态，例如程序计数器（PC）和寄存器的值，以便在处理完中断或异常后能够恢复到原始的执行现场。

2. 转到中断/异常处理程序：处理器会根据中断或异常的类型，跳转到预定义的中断处理程序或异常处理程序的入口点，开始执行相应的处理代码。

3. 处理中断/异常：中断处理程序或异常处理程序会执行相应的处理逻辑，例如读取输入设备的数据、处理错误、修复异常等，以解决中断或异常引发的问题。

4. 恢复执行现场：在中断或异常处理程序执行完毕后，处理器会恢复保存的执行现场，包括程序计数器和寄存器的值，以便继续执行被中断或异常中断的程序。

5. 继续执行：处理器会从保存的执行现场处继续执行被中断或异常中断的程序，从中断或异常点继续往下执行。

这是一个简化的处理流程，实际的中断和异常处理过程可能会更加复杂，涉及到硬件中断控制器、中断向量表、异常处理向量表等。处理中断和异常需要高效和准确的处理程序，以确保系统的稳定性和可靠性，并保护现有数据和状态的完整性。

在实模式和保护模式下，中断向量表是不同的。

在实模式下，中断向量表通常被称为中断向量表（Interrupt Vector Table，IVT），它是一段位于内存的连续地址空间，包含了处理器处理中断的入口点（中断处理程序）的地址。在实模式下，中断向量表的地址是固定的，位于物理内存的地址 0x0000 到 0x03FF（1KB）处。中断向量表中的每个条目都包含了一个中断处理程序的地址，用于处理特定的中断号。

而在保护模式下，中断向量表通常被称为中断描述符表（Interrupt Descriptor Table，IDT），它是一种数据结构，包含了处理器处理中断的详细信息，例如中断门（Interrupt Gate）或陷阱门（Trap Gate），以及相应的中断处理程序的段选择子和偏移量。在保护模式下，中断向量表的地址是由处理器中的特定寄存器（如IDTR，Interrupt Descriptor Table Register）指定的，可以位于任意的内存位置。

因此，实模式和保护模式下的中断向量表是不同的，包括其结构、地址和使用方式。在保护模式下，中断向量表更加灵活和强大，允许处理器支持更多的中断类型和具有更高级的中断处理功能。

## 3.2. 有关中断和异常了解性的内容

当处理器发生中断或异常时，会根据中断向量或异常向量中存储的地址信息跳转到相应的处理程序。这些向量是一组预定义的内存地址，用于存储中断处理程序或异常处理程序的入口点。

在 x86 架构的处理器中，中断向量表（Interrupt Vector Table，IVT）用于实模式下的中断处理，而中断描述符表（Interrupt Descriptor Table，IDT）用于保护模式下的中断和异常处理。IVT 和 IDT 中的每个条目（通常称为中断向量或异常向量）都包含了一个处理程序的地址，该地址指向处理特定中断或异常的代码。

中断源和异常源是触发中断和异常的事件或条件。中断源可以是外部设备的输入、定时器的溢出、硬件错误等，而异常源则通常是由处理器内部检测到的，例如非法的指令、访问越界的内存、除零错误等。

异常可以分为故障、陷阱和中止三种类型。故障是指在程序执行过程中发生的错误，例如非法的指令或访问越界的内存，它需要被处理并修复以继续程序的正常执行。陷阱是一种有意引发的异常，例如软件中断或调试中断，它通常用于程序中的特定目的，如调试、系统调用等。中止是指处理器检测到的严重错误，例如硬件错误或保护机制触发，可能导致系统的终止或重启。

程序或任务的重新执行通常在异常或中断处理程序中进行。当处理器执行异常或中断处理程序时，它可以保存当前的执行现场，包括寄存器状态、内存状态等，以便在处理完异常或中断后能够恢复到中断或异常中止的地方，从而重新执行被中断或异常中止的程序或任务。

开启和禁止中断是控制处理器是否接收中断请求的操作。处理器通常提供了一些特定的指令或寄存器来控制中断的开启和禁止。当中断被禁止时，处理器将不会响应任何中断请求；而当中断被开启时，处理器可以接收并响应中断请求。

异常和中断可以具有不同的优先级，以确定处理器在同时存在多个中断或异常请求时的处理顺序。处理器通常使用优先级来决定哪个中断或异常优先处理。较高优先级的中断或异常会在较低优先级的中断或异常之前得到处理，以确保处理紧急性较高的中断或异常能够尽快得到响应。优先级可以通过处理器的配置或设置来进行调整，通常由处理器的硬件或软件来管理。

在处理器的异常和中断处理中，优先级可以通过多种方式来确定，例如硬件固定优先级、软件可配置的优先级、中断或异常类型的优先级等。一般来说，硬件固定优先级是指处理器对不同中断或异常类型预定义了固定的优先级，无法通过软件进行修改。软件可配置的优先级则允许程序员或系统管理员根据需求动态地设置中断或异常的优先级。在处理多个中断或异常请求时，处理器会根据优先级决定哪个中断或异常先得到处理。

处理器在执行异常或中断处理程序时，通常会有一些机制来保护处理程序的执行现场和数据，以防止异常或中断处理程序对系统的其他部分造成破坏。这可能包括保存寄存器状态、切换堆栈、禁用或屏蔽其他中断或异常等。

在处理完异常或中断后，处理器会根据处理程序的要求或系统的配置来恢复到之前的执行状态，继续执行被中断或异常中止的程序或任务。这通常涉及恢复寄存器状态、堆栈状态以及可能的资源状态等。

中断和异常处理是计算机系统中的重要机制，用于处理外部事件、错误和特定操作，以确保系统的稳定性、可靠性和安全性。


## 3.3. 中断描述符表
1. 如何构成中断描述符：

中断描述符是一个8字节（64位）的数据结构，包含了中断处理程序的地址、特权级、段选择子等信息。在x86架构中，中断描述符的格式如下：

```
Bit 0-15: 中断处理程序的地址低16位
Bit 16-31: 中断处理程序的地址高16位
Bit 32-39: 保留位，通常设置为0
Bit 40-43: 特权级，用于指定中断处理程序的运行特权级
Bit 44: 存在位，用于表示中断描述符是否存在，1表示存在
Bit 45-46: 保留位，通常设置为0
Bit 47: 长模式位，用于表示中断处理程序的地址位数，0表示16位，1表示32位
Bit 48-63: 中断处理程序的地址高32位（只在长模式下有效）
```

2. 如何获得中断处理程序的地址：

中断处理程序的地址通常由操作系统或应用程序开发人员编写，并在中断描述符中设置。在编写中断处理程序时，需要注意将其地址设置为符合中断描述符格式的低16位和高16位，并根据处理器的特权级要求进行设置。

在汇编语言中，可以使用类似于以下的语法来设置中断处理程序的地址：

```assembly
; 设置中断处理程序的地址
mov word [中断描述符地址+0], 中断处理程序的地址低16位
mov word [中断描述符地址+2], 中断处理程序的地址高16位
```

在高级语言中，可以通过函数或指针来设置中断处理程序的地址，具体方式可能因编程语言和操作系统而异。

3. 如何设置中断描述符表寄存器：

在x86架构中，可以使用LGDT（Load Global Descriptor Table）或LLDT（Load Local Descriptor Table）指令来设置中断描述符表寄存器。具体步骤如下：

- LGDT指令：用于加载全局描述符表（GDT）的地址到GDTR寄存器中。

```assembly
lgdt [全局描述符表地址] ; 全局描述符表地址为中断描述符表的起始地址
```

- LLDT指令：用于加载局部描述符表（LDT）的地址到LDTR寄存器中。

```assembly
lldt [局部描述符表地址] ; 局部描述符表地址为中断描述符表的起始地址
```

需要注意的是，设置中断描述符表寄存器时，需要确保中断描述符表已经被加载到内存，并且可以被处理器访问到。在加载描述符表时，需要将描述符表的起始地址传递给相应的寄存器，以便处理器能够正确地找到中断处理程序的地址并跳转到相应的处理代码。具体的操作和配置方式可能因处理器和操作系统而异，需要根据具体的硬件和软件环境来进行设置。

在操作系统启动时，通常会初始化中断描述符表，并设置中断处理程序的地址、特权级等信息。操作系统会根据需要注册中断处理程序，并将其地址写入中断描述符表中相应的条目。当中断事件发生时，处理器会根据中断向量号或异常向量号在中断描述符表中查找对应的中断描述符，获取中断处理程序的地址，并跳转到该地址执行中断处理程序。

## 3.4. IDT 描述符

在x86架构的计算机系统中，中断描述符表（IDT，Interrupt Descriptor Table）用于存储中断门（Interrupt Gate）、陷阱门（Trap Gate）和任务门（Task Gate）等描述符，用于处理中断和异常。以下是这些描述符的格式：

1. 中断门（Interrupt Gate）：
中断门用于处理中断事件，如外部设备的中断请求。其格式如下：
```
  31              16 15 14 13     12 11 10  9  8  7  6  5  4  3  2  1  0
 +------------------+------------+---+----+-------------------+--+--+
 |     偏移地址      | 选择子   |P |DPL |        类型            |0 |0 |
 +------------------+------------+---+----+-------------------+--+--+
```
- 偏移地址（Offset）：表示中断处理程序的入口地址，即处理中断事件的代码段偏移地址。
- 选择子（Selector）：表示处理中断事件的代码段选择子，用于从全局描述符表（GDT）或局部描述符表（LDT）中选择代码段。
- P（Present）：表示中断门是否存在，如果为1表示存在，如果为0表示不存在。
- DPL（Descriptor Privilege Level）：表示中断门的特权级，用于控制中断处理程序的权限级别。
- 类型（Type）：表示中断门的类型，如中断门（0xE）和陷阱门（0xF）等。

2. 陷阱门（Trap Gate）：
陷阱门用于处理陷阱事件，如程序的断点调试。其格式与中断门类似，区别在于类型字段的值不同。

3. 任务门（Task Gate）：
任务门用于进行任务切换。其格式如下：
```
  31              16 15 14 13     12 11 10  9  8  7  6  5  4  3  2  1  0
 +------------------+------------+---+----+----+-----------------+--+--+
 |   忽略      |TSS选择子|P |DPL |0 |       类型         |0 |0 |
 +------------------+------------+---+----+----+-----------------+--+--+
```
- TSS选择子（TSS Selector）：表示任务状态段（TSS）的选择子，用于从全局描述符表（GDT）或局部描述符表（LDT）中选择TSS。
- P（Present）：表示任务门是否存在，如果为1表示存在，如果为0表示不存在。
- DPL（Descriptor Privilege Level）：表示任务门的特权级，用于控制任务切换的权限级别。
- 类型（Type）：表示任务门的类型，为0x5。

这些描述符格式中的字段含义和用途在处理器架构和操作系统的规范中有详细定义，开发者在编写中断和异常处理程序时需要根据这些格式进行正确的配置和使用。在处理中断和异常时，中断门、陷阱门和任务门的使用方式略有不同：

1. 中断门（Interrupt Gate）：
中断门用于处理中断事件，当发生中断时，处理器会根据中断门描述符中的偏移地址找到中断处理程序的入口地址，并执行相应的处理代码。处理器会自动保存当前的CPU状态，包括寄存器的值和标志位，并在处理完中断后恢复这些状态。

2. 陷阱门（Trap Gate）：
陷阱门用于处理陷阱事件，当发生陷阱时，处理器会根据陷阱门描述符中的偏移地址找到陷阱处理程序的入口地址，并执行相应的处理代码。与中断门不同的是，处理器在执行陷阱处理程序时不会自动保存和恢复CPU状态，因此陷阱门常用于调试和监控等需要精确控制的场景。

3. 任务门（Task Gate）：
任务门用于进行任务切换，当发生任务切换时，处理器会根据任务门描述符中的TSS选择子找到相应的任务状态段（TSS），并进行任务切换操作。

中断处理程序和被中断任务的优先级通常由中断向量号（Interrupt Vector）或异常向量号决定，向量号是中断或异常的唯一标识符。不同向量号对应不同的中断或异常，处理方式也可能不一样。

在处理中断和异常时，处理器会自动进行堆栈切换，将当前的CPU状态保存到堆栈中，并从中断或异常的描述符中获取相应的处理程序入口地址进行跳转执行。如果发生堆栈切换，处理器会保存当前的寄存器值、标志位和堆栈指针等信息，并将这些信息保存到堆栈中。处理完中断或异常后，处理器会从堆栈中恢复之前保存的状态，并从中断或异常处理程序的返回指令返回到被中断任务的下一条指令继续执行。

如果没有发生堆栈切换，处理器会直接从中断或异常处理程序的返回指令返回到被中断任务的下一条指令，不涉及堆栈的保存和恢复。

异常和中断处理过程需要保护处理器的状态和数据，通常会使用特权级别、栈段选择子、段描述符等机制来进行保护，以防止非授权的访问和篡改。

中断门与陷阱门的唯一区别是在处理器执行中断或陷阱处理程序时是否自动保存和恢复CPU状态。中断门会自动保存和恢复CPU状态，而陷阱门则不会自动保存.

##  中断与异常处理

中断过程调用的流程如下：

1. 当中断事件发生时，处理器会暂停当前任务的执行，并保存当前任务的上下文（如寄存器值、程序计数器等）到当前任务的堆栈上。
2. 处理器会根据中断向量号或异常向量号，在中断描述符表（IDT）中查找对应的中断门或陷阱门描述符。
3. 处理器会检查中断门或陷阱门的特权级与当前处理器状态的特权级，以判断中断处理程序的执行权限。
4. 如果中断门或陷阱门的特权级高于当前处理器状态的特权级，则处理器会进行特权级切换，将当前特权级切换为中断门或陷阱门的特权级，并加载中断门或陷阱门描述符中的代码段选择子和偏移量，跳转到中断处理程序的入口点。
5. 中断处理程序执行完毕后，处理器会从堆栈中恢复之前保存的任务上下文，并将控制权返回给之前被中断的任务继续执行。

中断处理过程与被中断任务的优先级的判断方式取决于处理器的特权级和中断门或陷阱门描述符的特权级。通常情况下，如果中断门或陷阱门的特权级高于当前处理器状态的特权级，那么中断处理程序会以高优先级执行。如果中断门或陷阱门的特权级与当前处理器状态的特权级相同或低于当前处理器状态的特权级，那么中断处理程序会以当前处理器状态的特权级执行。

在不同的优先级上，处理方式可以不同。例如，在高特权级下，中断处理程序可能具有更高的访问权限和更多的系统资源，而在低特权级下，中断处理程序可能受到限制，无法访问某些资源或执行某些特权指令。

当发生堆栈切换时，处理器会保存当前任务的上下文到当前任务的堆栈上，并加载中断门或陷阱门描述符中的代码段选择子和偏移量，跳转到中断处理程序的入口点。中断处理程序执行完毕后，处理器会从堆栈中恢复之前保存的任务上下文，并将控制权返回给之前被中断的任务继续执行。

如果没有发生堆栈切换，处理器会直接跳转到中断处理程序的入口点，而不保存当前任务的上下文。这意味着中断处理程序可以直接在当前任务的堆栈上执行，不需要进行堆栈切换的操作。

中断处理过程后，通常使用IRET（Interrupt Return）指令来返回。IRET指令会从中断处理程序中恢复之前保存的任务上下文，并将控制权返回给之前被中断的任务。IRET指令会从堆栈中弹出之前保存的代码段选择子、标志寄存器、段寄存器和程序计数器等信息，恢复任务的执行状态。

异常和中断处理过程的保护通常涉及以下几个方面：

1. 中断和异常处理程序应该被设计为可靠且高效的代码，不应该产生错误或导致系统崩溃。
2. 中断和异常处理程序需要保护系统的关键数据和资源，防止被非授权的访问或篡改。
3. 中断和异常处理程序需要遵循特权级的规则，不应该越权访问或修改高特权级的数据或资源。

异常和中断处理过程通常使用特定的标志寄存器来控制处理过程的行为。例如，x86 架构中的 EFLAGS 寄存器包含了处理器状态标志，如进位标志、零标志、溢出标志等，这些标志可以在中断和异常处理过程中用来判断处理结果或处理方式。

中断门与陷阱门的唯一区别是处理器对于中断门的响应方式。在处理中断门时，处理器会自动禁用（屏蔽）其他中断，而在处理陷阱门时，处理器不会屏蔽其他中断，允许嵌套中断。这意味着中断门在执行中断处理程序时会屏蔽其他中断，而陷阱门则不会。这种区别通常用于处理紧急情况下需要立即中断其他任务进行处理的情况（使用中断门），和在某些情况下需要处理器继续响应其他中断的情况（使用陷阱门）。

如果发生堆栈切换，处理器会执行以下操作：

1. 将当前任务的上下文保存到当前堆栈中，包括代码段选择子、标志寄存器、段寄存器、通用寄存器和堆栈指针等。
2. 切换到中断/异常处理程序的堆栈，并将中断/异常处理程序的堆栈帧压入堆栈，包括代码段选择子、标志寄存器、段寄存器、通用寄存器和堆栈指针等。
3. 跳转到中断/异常处理程序的入口地址开始执行处理过程。

如果没有发生堆栈切换，处理器会在当前任务的堆栈上执行中断/异常处理程序，不会进行堆栈切换操作。

中断处理过程后，处理器会执行以下操作：

1. 将中断/异常处理程序的返回地址从堆栈中弹出，将控制权返回到之前被中断的任务。
2. 恢复之前被中断任务的上下文，包括代码段选择子、标志寄存器、段寄存器、通用寄存器和堆栈指针等。
3. 通过执行IRET指令，将保存在堆栈中的代码段选择子、标志寄存器、段寄存器和程序计数器等信息弹出，恢复任务的执行状态。

异常和中断处理过程的标志使用方式通常涉及以下几种方式：

1. 中断处理程序可以通过检查标志寄存器中的状态标志来判断处理结果，例如进位标志、零标志、溢出标志等。
2. 中断处理程序可以通过设置标志寄存器中的控制标志来控制处理过程的行为，例如设置中断允许标志、方向标志等。
3. 中断处理程序可以通过保存和恢复标志寄存器中的状态来保护系统的标志状态，防止处理过程中对标志的非授权访问或篡改。

不同优先级上，处理方式可能会有所不同。通常情况下，高优先级的中断或异常会中断当前任务的执行，转而执行对应的中断/异常处理程序。低优先级的中断或异常可能会被忽略，直到当前任务执行完毕或手动允许低优先级中断/异常。

中断门和陷阱门在格式上是相同的，但在处理器对待它们的方式上有一些不同。中断门在处理时会自动屏蔽其他中断，而陷阱门不会屏蔽其他中断，允许嵌套中断。这意味着中断门在执行中断处理程序时会禁用其他中断，而陷阱门不会。这意味着在处理中断门时，处理器会自动将当前任务的中断允许标志位清零，从而禁止其他中断的发生；而在处理陷阱门时，处理器会保持当前任务的中断允许标志位不变，允许其他中断的发生。这是中断门和陷阱门之间的唯一区别。

在中断过程调用的流程中，当一个中断或异常发生时，处理器会执行以下步骤：

1. 中断或异常发生，处理器会自动保存当前任务的上下文，包括代码段选择子、标志寄存器、段寄存器、通用寄存器和堆栈指针等，将其保存到堆栈中。
2. 处理器会根据中断/异常向量号在中断描述符表中查找对应的中断门或陷阱门，获取中断处理程序的地址。
3. 处理器会跳转到中断处理程序的入口地址，并开始执行中断处理程序。
4. 中断处理程序会根据中断类型进行相应的处理，可能包括保存和恢复现场、处理中断请求、更新系统状态等。
5. 在中断处理程序执行完毕后，处理器会通过执行IRET指令，将保存在堆栈中的代码段选择子、标志寄存器、段寄存器和程序计数器等信息弹出，恢复任务的执行状态。
6. 处理器会继续执行被中断的任务，并从堆栈中恢复之前保存的上下文，继续任务的正常执行。

中断处理过程与被中断任务的优先级可以通过中断向量号或异常向量号来判断。通常情况下，中断向量号或异常向量号越低，优先级越高。处理器会根据中断/异常向量号在中断描述符表中查找对应的中断门或陷阱门，从而确定中断处理程序的地址。

异常和中断处理过程的保护通常涉及保存和恢复现场。在处理异常和中断时，处理器会自动保存当前任务的上下文到堆栈中，包括代码段选择子、标志寄存器、段寄存器、通用寄存器和堆栈指针等。这样可以保护当前任务的执行状态，使得在处理完异常或中断后能够正确恢复任务的执行。

在处理异常和中断时，处理器会使用特定的处理方式，例如清除标志、设置标志、修改系统状态等，以完成对异常或中断的处理。这些处理方式通常由中断处理程序编写者定义，根据具体的处理需求进行编程。

异常和中断处理过程是处理器与外部设备或系统交互的重要机制，用于处理外部事件和错误条件。中断和异常的处理过程包括保存和恢复现场、跳转到中断处理程序、执行处理逻辑以及从堆栈中恢复上下文等步骤。处理器通过中断描述符表中的中断门或陷阱门来确定中断处理程序的入口地址，并根据中断/异常向量号来确定优先级。在处理异常和中断时，处理器会自动保存当前任务的上下文，以便在处理完异常或中断后能够正确恢复任务的执行。处理异常和中断时，可以根据需要进行标志的设置、清除或修改系统状态等处理方式。

中断和异常的处理过程可能因处理器架构、操作系统或编程语言而异，因此具体的实现方式可能会有所不同。在编写中断处理程序时，需要遵循相应的处理器架构和操作系统的规范，以确保正确处理异常和中断，并保护任务的执行状态。同时，合理的中断和异常处理设计可以提高系统的稳定性和可靠性，确保系统对外部事件和错误条件的响应能力。