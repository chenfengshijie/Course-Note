# 1 系统级体系架构概述
1. 全局描述符表和局部描述符表：
全局描述符表（GDT）和局部描述符表（LDT）是IA-32体系结构中用于内存分段的数据结构。GDT是一个系统范围的表，为整个系统定义内存段，而每个进程都有自己的LDT，为该进程定义内存段。GDT和LDT用于将逻辑地址转换为物理地址，并执行内存保护。

2. 系统段、段描述符和门：
在IA-32体系结构中，系统段是系统用于存储处理器和操作系统的当前状态信息的内存段。段描述符是用于描述内存段属性和位置的数据结构。门是用于描述代码或任务的入口点的数据结构。

3. 任务状态段和任务门：
任务状态段（TSS）是用于存储任务状态信息的数据结构，包括处理器寄存器的值、任务的特权级别以及任务堆栈的位置。任务门用于通过从一个任务转移控制来在任务之间切换。它们提供了一种机制，使任务可以由操作系统进行调度和管理。

4. 中断和异常处理：
中断和异常是程序执行过程中发生的事件，例如硬件错误或软件中断。中断和异常处理是检测、识别和响应这些事件的过程。在IA-32体系结构中，中断描述符表（IDT）用于将中断和异常向量映射到中断和异常处理程序。

5. 内存管理：
内存管理是在计算机系统中分配和管理内存资源的过程。在IA-32体系结构中，内存管理通过分段和分页的组合来实现。分段将内存分为逻辑段，而分页将内存分为固定大小的页面。操作系统负责管理内存资源的分配和释放。

6. 系统寄存器：
系统寄存器是操作系统和处理器用于存储系统状态和配置信息的特殊目的寄存器。IA-32体系结构中的系统寄存器示例包括控制寄存器（CR）、调试寄存器（DR）和模型特定寄存器（MSR）。这些寄存器用于各种目的，例如内存管理、调试和性能监视。

# 2 实模式和保护模式转换
执行以下步骤：
1. 设置全局描述符表（GDT）：GDT是描述处理器使用的内存段的数据结构。在保护模式下，GDT用于定义内存保护方案。在切换到保护模式之前，您需要设置GDT。

2. 加载GDT寄存器：设置好GDT后，需要将GDT寄存器加载到GDT的基地址和限制大小。

3. 设置保护模式标志：要切换到保护模式，需要在控制寄存器0（CR0）中设置保护模式标志。此标志启用保护模式并禁用实模式。

4. 刷新指令流水线：设置了保护模式标志后，需要刷新指令流水线，以确保处理器开始在保护模式下执行指令。
```css
# 设置GDT
lgdt [gdtr]

# 在CR0中设置保护模式标志
mov eax, cr0
or eax, 0x01
mov cr0, eax

# 刷新指令流水线
jmp CODE_SEG:start_pm

# 保护模式代码段
BITS 32
start_pm:
    # 在此处编写保护模式代码

```
# 3.寄存器

1. EFLAGS 寄存器：EFLAGS 寄存器是一个 32 位的寄存器，其中包含一组标志，反映处理器的状态。这些标志包括进位标志、零标志、符号标志、溢出标志等。EFLAGS 寄存器用于控制处理器的各种操作，例如算术操作和内存访问。

2. GDTR、LDTR、IDTR、TR 寄存器：这些是 IA-32 架构中用于管理内存分段和任务切换的特殊寄存器。

    GDTR（全局描述符表寄存器）是一个 48 位的寄存器，指向全局描述符表（GDT）。GDT 是一个数据结构，定义处理器使用的内存段。

    LDTR（局部描述符表寄存器）是一个 16 位的寄存器，指向局部描述符表（LDT）。LDT 是一个数据结构，定义特定任务使用的内存段。

    IDTR（中断描述符表寄存器）是一个 48 位的寄存器，指向中断描述符表（IDT）。IDT 是一个数据结构，包含处理器使用的中断向量。

    TR（任务寄存器）是一个 16 位的寄存器，指向当前任务使用的任务状态段（TSS）。TSS 是一个数据结构，定义任务运行时处理器的状态。

3. CR0 到 CR3 寄存器：这些是 IA-32 架构中用于控制处理器各种方面的控制寄存器。
    CR0（控制寄存器 0）是一个 32 位的寄存器，控制处理器的操作模式、内存管理单元（MMU）和其他功能。

    CR1 寄存器在 IA-32 架构中未使用。

    CR2（控制寄存器 2）是一个 32 位的寄存器，包含导致页错误异常的页面故障线性地址（PFLA）。

    CR3（控制寄存器 3）是一个 32 位的寄存器，指向 MMU 使用的页面目录表（PDT）。PDT 是一个数据结构，将虚拟地址映射到物理地址。

# 系统指令

1. LGDT（加载全局描述符表）：该命令用于将全局描述符表（GDT）的基地址和限制加载到全局描述符表寄存器（GDTR）中。GDT 是定义处理器使用的内存段的数据结构。在从实模式切换到保护模式或更改 GDT 时使用 LGDT 命令。

2. SGDT（存储全局描述符表）：该命令用于将 GDT 的基地址和限制存储到操作数指定的内存位置中。这可用于保存 GDT 的当前状态以备将来恢复。

3. LIDT（加载中断描述符表）：该命令用于将中断描述符表（IDT）的基地址和限制加载到中断描述符表寄存器（IDTR）中。IDT 是定义处理器使用的中断向量的数据结构。在从实模式切换到保护模式或更改 IDT 时使用 LIDT 命令。

4. SIDT（存储中断描述符表）：该命令用于将 IDT 的基地址和限制存储到操作数指定的内存位置中。这可用于保存 IDT 的当前状态以备将来恢复。

5. LLDT（加载局部描述符表）：该命令用于将局部描述符表（LDT）的选择器加载到局部描述符表寄存器（LDTR）中。LDT 是定义特定任务使用的内存段的数据结构。

6. SLDT（存储局部描述符表）：该命令用于将 LDT 的选择器存储到操作数指定的内存位置中。这可用于保存 LDT 的当前状态以备将来恢复。

7. LTR（加载任务寄存器）：该命令用于将任务状态段（TSS）的选择器加载到任务寄存器（TR）中。TSS 是定义任务状态的数据结构。

8. STR（存储任务寄存器）：该命令用于将 TR 的内容存储到操作数指定的内存位置中。这可用于保存 TR 的当前状态以备将来恢复。

